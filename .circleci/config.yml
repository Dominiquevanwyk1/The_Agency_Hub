version: 2.1

orbs:
  node: circleci/node@6.3.0

jobs:
  security-and-quality-scan:
    docker:
      - image: cimg/node:20.12
    environment:
      NODE_OPTIONS: "--max_old_space_size=4096"

    steps:
      - checkout

      # Install Java (required for SonarScanner)
      - run:
          name: Install Java 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jre-headless
            java -version

      # Install Snyk CLI (User-level install â€” avoids permission issues)
      - run:
          name: Install Snyk CLI
          command: |
            mkdir -p $HOME/.local
            npm install snyk --prefix=$HOME/.local
            echo 'export PATH=$HOME/.local/node_modules/.bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            snyk --version

      # Install SonarScanner CLI
      - run:
          name: Install SonarScanner CLI
          command: |
            SCANNER_VERSION=5.0.1.3006
            curl -sSLo /tmp/sonar.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SCANNER_VERSION}-linux.zip
            unzip -q /tmp/sonar.zip -d $HOME
            mv $HOME/sonar-scanner-* $HOME/sonar-scanner
            echo 'export PATH="$HOME/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            echo 'export SONAR_SCANNER_OPTS="-Xmx1024m"' >> $BASH_ENV
            source $BASH_ENV
            sonar-scanner --version

      # ---------- FRONTEND PIPELINE ----------
      - run:
          name: Frontend - Install Dependencies
          command: |
            cd "Versatile Visions/Frontend"
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

      - run:
          name: Frontend - Run Tests (optional)
          command: |
            cd "Versatile Visions/Frontend"
            npm run test:ci || echo "No frontend tests configured yet"

      - run:
          name: Frontend - Snyk Security Scan
          command: |
            source $BASH_ENV
            cd "Versatile Visions/Frontend"
            snyk auth "${SNYK_TOKEN}"
            snyk test --severity-threshold=medium || true
            snyk monitor --org="${SNYK_ORG}" --project-name="versatile-visions-frontend" || true

      - run:
          name: Frontend - SonarCloud Analysis
          command: |
            source $BASH_ENV
            cd "Versatile Visions/Frontend"
            sonar-scanner \
              -Dsonar.projectKey=versatile-visions-frontend \
              -Dsonar.organization="${SONAR_ORG}" \
              -Dsonar.host.url="https://sonarcloud.io" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.sources=.

      # ---------- BACKEND PIPELINE ----------
      - run:
          name: Backend - Install Dependencies
          command: |
            cd "Versatile Visions/Backend"
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

      - run:
          name: Backend - Run Tests (optional)
          command: |
            cd "Versatile Visions/Backend"
            npm run test:ci || echo "No backend tests configured yet"

      - run:
          name: Backend - Snyk Security Scan
          command: |
            source $BASH_ENV
            cd "Versatile Visions/Backend"
            snyk auth "${SNYK_TOKEN}"
            snyk test --severity-threshold=medium || true
            snyk monitor --org="${SNYK_ORG}" --project-name="versatile-visions-backend" || true

      - run:
          name: Backend - SonarCloud Analysis
          command: |
            source $BASH_ENV
            cd "Versatile Visions/Backend"
            sonar-scanner \
              -Dsonar.projectKey=versatile-visions-backend \
              -Dsonar.organization="${SONAR_ORG}" \
              -Dsonar.host.url="https://sonarcloud.io" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.sources=.

workflows:
  version: 2

  # Nightly scheduled run (2 AM UTC)
  nightly-security-and-quality:
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - security-and-quality-scan

  # Run automatically on pushes to main/develop
  on-push:
    jobs:
      - security-and-quality-scan:
          filters:
            branches:
              only:
                - main
                - develop