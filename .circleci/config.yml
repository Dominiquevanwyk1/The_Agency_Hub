version: 2.1
orbs:
  node: circleci/node@6.3.0

jobs:
  security-and-quality-scan:
    docker:
      - image: 'cimg/node:20.12'
    environment:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - checkout

      - run:
          name: Verify Folder Structure
          command: |
            echo "==== Project Directory Structure ===="
            find . -maxdepth 3 -type d
            echo "====================================="

      - run:
          name: Detect Frontend and Backend folders
          command: |
            echo "Detecting project folders..."

            # Collect up to 2 package.json paths safely
            PACKAGE_PATHS=($(find . -type f -name package.json | head -n 2 || true))

            if [ ${#PACKAGE_PATHS[@]} -lt 1 ]; then
              echo "❌ No package.json files found. Check your repo structure."
              exit 1
            fi

            FRONTEND_PATH=$(dirname "${PACKAGE_PATHS[0]}")
            echo "✅ Detected frontend path: $FRONTEND_PATH"
            echo "export FRONTEND_PATH=$FRONTEND_PATH" >> $BASH_ENV

            if [ ${#PACKAGE_PATHS[@]} -ge 2 ]; then
              BACKEND_PATH=$(dirname "${PACKAGE_PATHS[1]}")
              echo "✅ Detected backend path: $BACKEND_PATH"
              echo "export BACKEND_PATH=$BACKEND_PATH" >> $BASH_ENV
            else
              echo "⚠️ Only one package.json found; skipping backend detection."
            fi

            source $BASH_ENV

      - run:
          name: Install Java 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jre-headless
            java -version

      - run:
          name: Install Snyk CLI
          command: |
            mkdir -p $HOME/.local
            npm install snyk --prefix=$HOME/.local
            echo 'export PATH=$HOME/.local/node_modules/.bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            snyk --version

      - run:
          name: Install SonarScanner CLI
          command: |
            SCANNER_VERSION=5.0.1.3006
            curl -sSLo /tmp/sonar.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SCANNER_VERSION}-linux.zip
            unzip -q /tmp/sonar.zip -d $HOME
            mv $HOME/sonar-scanner-* $HOME/sonar-scanner
            echo 'export PATH="$HOME/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            echo 'export SONAR_SCANNER_OPTS="-Xmx1024m"' >> $BASH_ENV
            source $BASH_ENV
            sonar-scanner --version

      - run:
          name: Frontend - Install Dependencies
          command: |
            source $BASH_ENV
            echo "Installing frontend dependencies in $FRONTEND_PATH"
            cd "$FRONTEND_PATH"
            npm ci || npm install

      - run:
          name: Frontend - Tests
          command: |
            source $BASH_ENV
            cd "$FRONTEND_PATH"
            npm run test:ci || echo "No frontend tests configured"

      - run:
          name: Frontend - Snyk Scan
          command: |
            source $BASH_ENV
            cd "$FRONTEND_PATH"
            snyk auth "${SNYK_TOKEN}"
            snyk test --severity-threshold=medium || true
            snyk monitor --org="${SNYK_ORG}" --project-name="versatile-visions-frontend" || true

      - run:
          name: Frontend - SonarCloud Scan
          command: |
            source $BASH_ENV
            if [ -z "${FRONTEND_PATH:-}" ]; then
              echo "❌ FRONTEND_PATH not set. Aborting Sonar scan."
              exit 1
            fi

            SONAR_BRANCH="${CIRCLE_BRANCH:-main}"
            echo "Running SonarScanner from frontend base dir: $FRONTEND_PATH on branch $SONAR_BRANCH"

            cd "$FRONTEND_PATH"
            sonar-scanner \
              -Dsonar.projectKey=versatile-visions-frontend \
              -Dsonar.organization="${SONAR_ORG}" \
              -Dsonar.host.url="https://sonarcloud.io" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.projectBaseDir="$FRONTEND_PATH" \
              -Dsonar.sources=. \
              -Dsonar.exclusions="**/node_modules/**,**/*.spec.js,**/*.test.js" \
              -Dsonar.branch.name="$SONAR_BRANCH"

      - run:
          name: Backend - Install Dependencies
          command: |
            source $BASH_ENV
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend install."
            else
              echo "Installing backend dependencies in $BACKEND_PATH"
              cd "$BACKEND_PATH"
              npm ci || npm install
            fi

      - run:
          name: Backend - Tests
          command: |
            source $BASH_ENV
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend tests."
            else
              cd "$BACKEND_PATH"
              npm run test:ci || echo "No backend tests configured"
            fi

      - run:
          name: Backend - Snyk Scan
          command: |
            source $BASH_ENV
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend Snyk."
            else
              cd "$BACKEND_PATH"
              snyk auth "${SNYK_TOKEN}"
              snyk test --severity-threshold=medium || true
              snyk monitor --org="${SNYK_ORG}" --project-name="versatile-visions-backend" || true
            fi

      - run:
          name: Backend - SonarCloud Scan
          command: |
            source $BASH_ENV
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend SonarCloud."
            else
              SONAR_BRANCH="${CIRCLE_BRANCH:-main}"
              cd "$BACKEND_PATH"
              sonar-scanner \
                -Dsonar.projectKey=versatile-visions-backend \
                -Dsonar.organization="${SONAR_ORG}" \
                -Dsonar.host.url="https://sonarcloud.io" \
                -Dsonar.login="${SONAR_TOKEN}" \
                -Dsonar.projectBaseDir="$BACKEND_PATH" \
                -Dsonar.sources=. \
                -Dsonar.exclusions="**/node_modules/**,**/*.spec.js,**/*.test.js" \
                -Dsonar.branch.name="$SONAR_BRANCH"
            fi

workflows:
  version: 2
  nightly-security-and-quality:
    jobs:
      - security-and-quality-scan
