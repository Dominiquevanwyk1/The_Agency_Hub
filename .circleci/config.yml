version: 2.1
orbs:
  node: circleci/node@6.3.0

jobs:
  security-and-quality-scan:
    docker:
      - image: 'cimg/node:20.12'
    environment:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - checkout

      - run:
          name: Verify Folder Structure
          command: |
            echo "==== Project Directory Structure ===="
            find . -maxdepth 3 -type d
            echo "====================================="

      - run:
          name: Detect Frontend and Backend folders
          command: |
            set -eo pipefail
            echo "Detecting project folders (excluding node_modules)..."

            # Collect package.json files excluding node_modules
            mapfile -t PACKAGE_PATHS < <(find . -path '*/node_modules/*' -prune -o -type f -name package.json -print)

            if [ ${#PACKAGE_PATHS[@]} -lt 1 ]; then
              echo "❌ No package.json files found. Check your repo structure."
              exit 1
            fi

            echo "Found package.json files:"
            printf '%s\n' "${PACKAGE_PATHS[@]}"

            # Prefer common frontend directories
            preferred_dirs=('frontend' 'client' 'web' 'app' 'ui')
            PREF_FRONT=""
            for d in "${preferred_dirs[@]}"; do
              for p in "${PACKAGE_PATHS[@]}"; do
                if [[ "$p" == *"/$d/package.json" ]]; then
                  PREF_FRONT="$p"
                  break 2
                fi
              done
            done

            if [ -n "$PREF_FRONT" ]; then
              FRONT_PKG="$PREF_FRONT"
              echo "✅ Preferred frontend package.json found: $FRONT_PKG"
            else
              SHALLOW=$(printf '%s\n' "${PACKAGE_PATHS[@]}" | awk -F"/" '{print NF, $0}' | sort -n | head -n 1 | cut -d" " -f2-)
              FRONT_PKG="$SHALLOW"
              echo "✅ Selected shallowest package.json as frontend: $FRONT_PKG"
            fi

            FRONTEND_PATH=$(dirname "$FRONT_PKG")
            echo "Detected FRONTEND_PATH: $FRONTEND_PATH"
            echo "export FRONTEND_PATH=$FRONTEND_PATH" >> $BASH_ENV

            BACKEND_PKG=""
            for p in "${PACKAGE_PATHS[@]}"; do
              if [ "$p" != "$FRONT_PKG" ]; then
                BACKEND_PKG="$p"
                break
              fi
            done

            if [ -n "$BACKEND_PKG" ]; then
              BACKEND_PATH=$(dirname "$BACKEND_PKG")
              echo "Detected BACKEND_PATH: $BACKEND_PATH"
              echo "export BACKEND_PATH=$BACKEND_PATH" >> $BASH_ENV
            else
              echo "⚠️ No separate backend package.json detected; skipping backend steps."
            fi

            # Make environment variables available to later steps
            source "$BASH_ENV"

      - run:
          name: Install Java 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jre-headless
            java -version

      - run:
          name: Install Snyk CLI
          command: |
            mkdir -p "$HOME/.local"
            npm install snyk --prefix="$HOME/.local"
            echo 'export PATH=$HOME/.local/node_modules/.bin:$PATH' >> $BASH_ENV
            source "$BASH_ENV"
            snyk --version

      - run:
          name: Install SonarScanner CLI
          command: |
            SCANNER_VERSION=5.0.1.3006
            curl -sSLo /tmp/sonar.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SCANNER_VERSION}-linux.zip
            unzip -q /tmp/sonar.zip -d "$HOME"
            mv "$HOME"/sonar-scanner-* "$HOME/sonar-scanner"
            echo 'export PATH="$HOME/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            echo 'export SONAR_SCANNER_OPTS="-Xmx1024m"' >> $BASH_ENV
            source "$BASH_ENV"
            sonar-scanner --version

      - run:
          name: Frontend - Install Dependencies
          command: |
            source "$BASH_ENV"
            if [ -z "${FRONTEND_PATH:-}" ]; then
              echo "❌ FRONTEND_PATH not set. Aborting frontend install."
              exit 1
            fi
            echo "Installing frontend dependencies in $FRONTEND_PATH"
            cd "$FRONTEND_PATH"
            npm ci || npm install

      - run:
          name: Frontend - Tests
          command: |
            source "$BASH_ENV"
            cd "$FRONTEND_PATH"
            npm run test:ci || echo "No frontend tests configured"

      - run:
          name: Frontend - Snyk Scan
          command: |
            source "$BASH_ENV"
            cd "$FRONTEND_PATH"
            snyk auth "${SNYK_TOKEN}" || true
            snyk test --severity-threshold=medium || true
            snyk monitor --org="${SNYK_ORG}" --project-name="The_Agency_Hub" || true

      - run:
          name: Frontend - SonarCloud Scan (diagnostics + debug)
          command: |
            set -eo pipefail
            source "$BASH_ENV"

            # Hardcoded to your SonarCloud project/org
            SONAR_PROJECT_KEY="The_Agency_Hub"
            SONAR_ORG="Dominique"
            SONAR_BRANCH="${CIRCLE_BRANCH:-main}"

            if [ -z "${SONAR_TOKEN:-}" ]; then
              echo "❌ SONAR_TOKEN not set in CircleCI environment variables."
              exit 1
            fi
            if [ -z "${FRONTEND_PATH:-}" ]; then
              echo "❌ FRONTEND_PATH not set. Aborting Sonar scan."
              exit 1
            fi

            echo "Diagnostics:"
            echo "  SONAR_PROJECT_KEY: $SONAR_PROJECT_KEY"
            echo "  SONAR_ORG: $SONAR_ORG"
            echo "  SONAR_BRANCH: $SONAR_BRANCH"
            echo "  FRONTEND_PATH: $FRONTEND_PATH"
            echo ""

            echo "Checking SonarCloud for project info (projects/search)..."
            curl -sS -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/projects/search?projects=${SONAR_PROJECT_KEY}" || true
            echo ""
            echo "Checking SonarCloud for branches (project_branches/list)..."
            curl -sS -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/project_branches/list?project=${SONAR_PROJECT_KEY}" || true
            echo ""

            cd "$FRONTEND_PATH" || { echo "Cannot cd to $FRONTEND_PATH"; exit 1; }

            # Run scanner once; on failure re-run with -X for debug logs
            if sonar-scanner \
                -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
                -Dsonar.organization="${SONAR_ORG}" \
                -Dsonar.host.url="https://sonarcloud.io" \
                -Dsonar.login="${SONAR_TOKEN}" \
                -Dsonar.projectBaseDir="$(pwd)" \
                -Dsonar.sources=. \
                -Dsonar.exclusions="**/node_modules/**,**/*.spec.js,**/*.test.js" \
                -Dsonar.branch.name="${SONAR_BRANCH}"
            then
              echo "✅ SonarScanner completed successfully."
            else
              echo "⚠️ SonarScanner failed. Re-running with -X for debug output..."
              sonar-scanner -X \
                -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
                -Dsonar.organization="${SONAR_ORG}" \
                -Dsonar.host.url="https://sonarcloud.io" \
                -Dsonar.login="${SONAR_TOKEN}" \
                -Dsonar.projectBaseDir="$(pwd)" \
                -Dsonar.sources=. \
                -Dsonar.exclusions="**/node_modules/**,**/*.spec.js,**/*.test.js" \
                -Dsonar.branch.name="${SONAR_BRANCH}" || true

              echo "SonarScanner debug run complete. See logs above for details."
              exit 1
            fi

      - run:
          name: Backend - Install Dependencies
          command: |
            source "$BASH_ENV"
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend install."
            else
              echo "Installing backend dependencies in $BACKEND_PATH"
              cd "$BACKEND_PATH"
              npm ci || npm install
            fi

      - run:
          name: Backend - Tests
          command: |
            source "$BASH_ENV"
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend tests."
            else
              cd "$BACKEND_PATH"
              npm run test:ci || echo "No backend tests configured"
            fi

      - run:
          name: Backend - Snyk Scan
          command: |
            source "$BASH_ENV"
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend Snyk."
            else
              cd "$BACKEND_PATH"
              snyk auth "${SNYK_TOKEN}" || true
              snyk test --severity-threshold=medium || true
              snyk monitor --org="${SNYK_ORG}" --project-name="The_Agency_Hub-backend" || true
            fi

      - run:
          name: Backend - SonarCloud Scan (diagnostics + debug)
          command: |
            set -eo pipefail
            source "$BASH_ENV"

            SONAR_PROJECT_KEY="The_Agency_Hub"
            SONAR_ORG="Dominique"
            SONAR_BRANCH="${CIRCLE_BRANCH:-main}"

            if [ -z "${SONAR_TOKEN:-}" ]; then
              echo "❌ SONAR_TOKEN not set in CircleCI environment variables."
              exit 1
            fi
            if [ -z "${BACKEND_PATH:-}" ]; then
              echo "No backend detected; skipping backend SonarCloud."
              exit 0
            fi

            echo "Diagnostics (backend):"
            echo "  SONAR_PROJECT_KEY: $SONAR_PROJECT_KEY"
            echo "  SONAR_ORG: $SONAR_ORG"
            echo "  SONAR_BRANCH: $SONAR_BRANCH"
            echo "  BACKEND_PATH: $BACKEND_PATH"
            echo ""

            echo "Checking SonarCloud for project info (projects/search)..."
            curl -sS -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/projects/search?projects=${SONAR_PROJECT_KEY}" || true
            echo ""
            echo "Checking SonarCloud for branches (project_branches/list)..."
            curl -sS -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/project_branches/list?project=${SONAR_PROJECT_KEY}" || true
            echo ""

            cd "$BACKEND_PATH" || { echo "Cannot cd to $BACKEND_PATH"; exit 1; }

            if sonar-scanner \
                -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
                -Dsonar.organization="${SONAR_ORG}" \
                -Dsonar.host.url="https://sonarcloud.io" \
                -Dsonar.login="${SONAR_TOKEN}" \
                -Dsonar.projectBaseDir="$(pwd)" \
                -Dsonar.sources=. \
                -Dsonar.exclusions="**/node_modules/**,**/*.spec.js,**/*.test.js" \
                -Dsonar.branch.name="${SONAR_BRANCH}"
            then
              echo "✅ Backend SonarScanner completed successfully."
            else
              echo "⚠️ Backend SonarScanner failed. Re-running with -X for debug output..."
              sonar-scanner -X \
                -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
                -Dsonar.organization="${SONAR_ORG}" \
                -Dsonar.host.url="https://sonarcloud.io" \
                -Dsonar.login="${SONAR_TOKEN}" \
                -Dsonar.projectBaseDir="$(pwd)" \
                -Dsonar.sources=. \
                -Dsonar.exclusions="**/node_modules/**,**/*.spec.js,**/*.test.js" \
                -Dsonar.branch.name="${SONAR_BRANCH}" || true

              echo "SonarScanner debug run complete (backend). See logs above for details."
              exit 1
            fi

workflows:
  version: 2
  nightly-security-and-quality:
    jobs:
      - security-and-quality-scan
